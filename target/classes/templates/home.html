<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ponabri</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; }
        h1, h2 { color: #007bff; text-align: center; margin-bottom: 15px; }
        .data-section { border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px; }
        ul { list-style: none; padding: 0; }
        li { background-color: #e9ecef; margin-bottom: 10px; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        li strong { color: #0056b3; }
        .message-box {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
        }
        .message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-box.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>

    <script src="/js/authInterceptor.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard Ponabri</h1>
        <p>Bem-vindo(a) ao seu painel! Aqui você pode acessar os dados da aplicação.</p>

        <div id="loadingMessage" class="message-box info" style="display: none;">Carregando dados...</div>
        <div id="errorMessage" class="message-box error" style="display: none;"></div>

        <div id="abrigosData" class="data-section">
            <h2>Lista de Abrigos</h2>
            <ul id="abrigosList">
                </ul>
        </div>

        <div class="data-section">
            <h2>Acessar Outras Páginas</h2>
            <ul>
                <li><a href="/abrigos">Abrigos</a></li>
                <li><a href="/reservas">Reservas</a></li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const abrigosList = document.getElementById('abrigosList');

            // 1. Verificar Token no localStorage
            const token = localStorage.getItem('jwtToken'); // <<< CORRIGIDO PARA 'jwtToken'
            if (!token) {
                // Se não há token, redireciona para o login
                window.location.href = '/login';
                return; // Importante para parar a execução
            }

            // Exibir mensagem de carregamento
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none'; // Esconder erro anterior

            // 2. Função para exibir mensagens
            function showMessage(element, message, type) {
                element.textContent = message;
                element.classList.remove('error', 'info'); // Limpa classes
                element.classList.add(type);
                element.style.display = 'block';
            }

            // 3. Função para buscar dados da API protegida
            async function fetchProtectedData() {
                try {
                    // Exemplo: Buscar lista de abrigos da API protegida
                    // O authInterceptor.js DEVE adicionar o cabeçalho Authorization automaticamente aqui
                    const response = await fetch('/api/abrigos', {
                        method: 'GET',
                        // Não precisamos adicionar 'headers' aqui se o authInterceptor.js fizer o trabalho
                        // de interceptar e adicionar o token para todas as requisições
                    });

                    loadingMessage.style.display = 'none'; // Esconde o carregamento

                    if (response.ok) {
                        const abrigos = await response.json();
                        abrigosList.innerHTML = ''; // Limpa a lista

                        if (abrigos.length === 0) {
                            abrigosList.innerHTML = '<li>Nenhum abrigo cadastrado.</li>';
                        } else {
                            abrigos.forEach(abrigo => {
                                const listItem = document.createElement('li');
                                listItem.innerHTML = `
                                    <strong>${abrigo.nomeLocal || 'Nome Indefinido'}</strong>
                                    <span>Endereço: ${abrigo.endereco || 'N/A'}</span>
                                    <span>Capacidade: ${abrigo.capacidadePessoas || 'N/A'}</span>
                                `;
                                abrigosList.appendChild(listItem);
                            });
                        }
                    } else if (response.status === 401 || response.status === 403) {
                        // Se não autorizado, redireciona para login
                        showMessage(errorMessage, 'Sessão expirada ou não autorizada. Redirecionando para o login...', 'error');
                        localStorage.removeItem('jwtToken'); // Limpa token inválido
                        setTimeout(() => { window.location.href = '/login'; }, 1500);
                    } else {
                        const errorBody = await response.text(); // Pega o texto do erro para exibir
                        showMessage(errorMessage, `Falha ao carregar dados: ${response.status} - ${errorBody}`, 'error');
                        console.error('Erro na API:', response.status, errorBody);
                    }
                } catch (error) {
                    showMessage(errorMessage, 'Erro de conexão ou ao buscar dados da API. Verifique o console.', 'error');
                    console.error('Erro de fetch:', error);
                }
            }

            // Chama a função para buscar dados ao carregar a página
            fetchProtectedData();
        });
    </script>
</body>
</html>